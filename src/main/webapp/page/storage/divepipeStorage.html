<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>查询剩余位置</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../../layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="../../font-awesome/css/font-awesome.min.css"/>
</head>
<body>
<div style="display: none" id="tubId"></div>
<!--<blockquote class="layui-elem-quote news_search">
    <div class="layui-inline">
        <div class="layui-input-inline">
            <input type="text" value="" placeholder="请输入需要的麦管数" class="layui-input search_input">
        </div>
        <a class="layui-btn search_btn">查询&nbsp;&nbsp;<i class="fa fa-search fa-1g"></i></a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-danger batchDel">自定义存储&nbsp;&nbsp;<i class="fa fa-snowflake-o"></i></a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-normal reload" style="background-color:#269f42">刷新&nbsp;<i class="fa fa-refresh" aria-hidden="true"></i></a>
    </div>
    <div class="layui-inline">
        <div class="layui-form-mid layui-word-aux record">&nbsp;&nbsp;&nbsp;&nbsp;<span></span></div>
    </div>
</blockquote>-->
<div class="layui-form divepipe_list">
    <table class="layui-table">
        <colgroup>
            <col width="4%">
            <col width="10%">
            <col width="10%">
            <col width="10%">
            <col width="10%">
        </colgroup>
        <thead>
        <tr>
            <th></th>
            <th>套管编号</th>
            <th>液氮罐编号</th>
            <th>吊桶编号</th>
            <th>可存放麦管数</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody class="divepipe_content"></tbody>
    </table>
</div>
<div id="page" style="margin-left: 200px"></div>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script>
    layui.use(['form','element', 'layer','laypage','jquery'], function(){
        var form = layui.form();
        var layer = layui.layer;
        laypage = layui.laypage;
        $ = layui.jquery;

        //加载页面数据
        var divepipeData = '';
        loadData();
        function loadData() {
            console.log($("#tubId").text())
            var tubId = $("#tubId").text();
            $.ajax({
                url : "/divepipeByTubId/"+tubId,
                type : "get",
                dataType : "json",
                success : function (data) {
                    //正常加载信息
                    divepipeData = data;
                    $(".record span").html("一共"+data.length+"条记录");
                    console.log(data);
                    //执行加载数据的方法
                    divepipeList();
                }
            });
        }

        //根据可存放麦管数目进行查询
        $(".search_btn").click(function () {
            if ($(".search_input").val() != ''){
                var index = layer.msg('查询中，请稍后',{icon: 16, time: false, shade: 0.8});
                setTimeout(function () {
                    $.ajax({
                        url : "/getDivepipeByFlagNum",
                        type : "get",
                        dataType : "json",
                        data : {
                            flagNum : $(".search_input").val()
                        },
                        success : function (data) {
                            $(".record span").html("一共"+data.length+"条记录");
                            divepipeList(data);
                        }

                    });
                    layer.close(index);
                },2000);
            }else {
                loadData();
            }
        })

        //冷冻存储
        $("body").on("click",".freezeStorage",function () {
            var _this = $(this);
            for(var i=0; i<divepipeData.length; i++){
                if (divepipeData[i].divepipeId == _this.attr("data-id")){
                    //获取当前点击的病人ID
                    var divepipeId = divepipeData[i].divepipeId;
                    var index = layui.layer.open({
                        title : "冷冻存储",
                        type : 2,
                        content : "freezeStorage.html",
                        success : function (layero,index) {
                            //获取子页面
                            var body = layui.layer.getChildFrame('body', index);
                            body.find("#divepipeId").val(divepipeId);
                            $.ajax({
                                url : "/nit/"+divepipeId,
                                type : "get",
                                dataType : "json",
                                success : function (data) {
                                    console.log(data)
                                    body.find(".nitNum").text(data.nitNum);
                                    body.find(".tubNum").text(data.tubNum);
                                    body.find(".divepipeNum").text(data.divepipeNum);
                                    body.find(".flagNum").text(data.flagNum);
                                    body.find("#divepipeId").val(data.divepipeId);
                                }
                            })
                        }
                    })
                    //改变窗口大小时，重置弹窗的高度，防止超出可视区域（如F12调出debug的操作）
                    $(window).resize(function () {
                        layui.layer.full(index);
                    })
                    layui.layer.full(index);
                }
            }

        })

        //加载数据
        function divepipeList(that) {
            //渲染数据
            function renderData(data,curr) {
                var dataHtml = '';
                if (!that){
                    currData = divepipeData.concat().splice(curr*nums-nums, nums);
                }else {
                    currData = that.concat().splice(curr*nums-nums, nums);
                }
                if (currData.length != 0){
                    for (var i=0; i<currData.length; i++){
                        dataHtml += '<tr>'
                            + '<td></td>>'
                            + '<td>' + currData[i].divepipeNum + '</td>'
                            + '<td>' + currData[i].nitNum + '</td>'
                            + '<td>' + currData[i].tubNum + '</td>'
                            + '<td>' + currData[i].flagNum + '</td>'
                            + '<td>'
                            +   '<a class="layui-btn layui-btn-mini freezeStorage" data-id="'+currData[i].divepipeId+'"><i class="fa fa-snowflake-o"></i>&nbsp;冷冻存储 </a>'
                            + '</td>'
                            + '</tr>>';
                    }
                }else {
                    dataHtml += '<tr><td colspan="12">暂无记录</td></tr>'
                }
                return dataHtml;
            }

            //分页
            var nums = 11;//每页出现的数据量
            if (that){
                divepipeData = that;
            }
            laypage({
                cont : "page",
                pages : Math.ceil(divepipeData.length/nums),
                jump : function (obj) {
                    $(".divepipe_content").html(renderData(divepipeData,obj.curr));
                    $('.divepipe_list thead input[type="checked"]').prop("checked",false);
                    form.render();
                }
            })
        }
    });
</script>
</body>
</html>